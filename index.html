<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IC CMS - Dashboard</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      background: linear-gradient(180deg, rgb(117, 81, 194), rgb(255, 255, 255));
      min-height: 100vh;
    }
    .content-container {
      padding-top: 1rem;
    }
    .action-nav {
      background-color: rgba(255, 255, 255, 0.2);
      padding: 0.5rem;
      border-radius: 0 0 8px 8px;
      margin-bottom: 1rem;
    }
  </style>
  
  <!-- AWS Amplify (load in head with defer) -->
  <script defer src="https://unpkg.com/aws-amplify@4.3.43/dist/aws-amplify.min.js"></script>
  <script defer src="navbar.js"></script>
  <script defer src="role-notifications.js"></script>
</head>
<body class="bg-light">
  <!-- Navigation bar is now loaded from navbar.js -->
  
  <!-- Action Navigation -->
  <div class="container-fluid action-nav">
    <div class="row g-2">
      <div class="col-md-3">
        <button class="btn btn-light w-100" data-bs-toggle="modal" data-bs-target="#createPostModal">Create New Post</button>
      </div>
      <div class="col-md-3">
        <a href="group-management.html" class="btn btn-light w-100" data-requires-role="ApplicationAdmin,GroupAdmin,GroupOfficer">Manage Groups</a>
      </div>
      <div class="col-md-3">
        <a href="user-management.html" class="btn btn-light w-100" data-requires-role="ApplicationAdmin">Manage Users</a>
      </div>
      <div class="col-md-3">
        <button class="btn btn-light w-100" id="viewProfileBtn">My Profile</button>
      </div>
    </div>
  </div>

  <div class="container content-container">
    <!-- Announcements -->
    <section class="mb-4">
      <h4 class="text-white">Announcements</h4>
      <div id="announcements" class="bg-white p-3 border rounded shadow-sm">
        <p>Loading announcements...</p>
      </div>
    </section>
    
    <!-- Create Post Modal -->
    <div class="modal fade" id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createPostModalLabel">Create New Post</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="createPostForm">
              <div class="mb-3">
                <label for="postTitle" class="form-label">Title</label>
                <input type="text" class="form-control" id="postTitle" required>
              </div>
              <div class="mb-3">
                <label for="postGroup" class="form-label">Group</label>
                <select class="form-control" id="postGroup">
                  <option value="general">General</option>
                  <option value="faculty">Faculty</option>
                  <option value="staff">Staff</option>
                  <option value="students">Students</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="postMessage" class="form-label">Message</label>
                <textarea class="form-control" id="postMessage" rows="4" required></textarea>
              </div>
              <div class="mb-3">
                <label for="postAttachment" class="form-label">Attachment (optional)</label>
                <input type="file" class="form-control" id="postAttachment">
                <div class="form-text">Max file size: 5MB</div>
              </div>
            </form>
            <div id="postStatus" class="alert d-none"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="submitPost">Post</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Events section removed as requested -->
  </div>

  <!-- jQuery and Bootstrap -->
  <script src="jquery-3.1.0.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Configuration -->
  <script src="config.js"></script>
  <script src="amplify-config.js"></script>
  <script src="post-author-handler.js"></script>

  <script>
async function loadPosts() {
  try {
    const session = await Amplify.Auth.currentSession();
    
    // Get ID token for authorization
    const idToken = session.getIdToken().getJwtToken();
    console.log("Using ID Token for authorization");
    
    // Get current user info to use for posts without author data
    const currentUser = await Amplify.Auth.currentAuthenticatedUser();
    window.currentUserProfilePicture = null;
    window.currentUsername = currentUser.username;
    console.log("Current username:", window.currentUsername);
    
    // Try to get user's profile picture from API
    try {
      const userResponse = await fetch(`${_config.api.invokeUrl}/cms/users/me`, {
        method: 'GET',
        headers: {
          'Authorization': idToken,
          'Content-Type': 'application/json'
        }
      });
      
      if (userResponse.ok) {
        const userData = await userResponse.json();
        console.log("User data:", userData);
        if (userData.profilePicture) {
          window.currentUserProfilePicture = userData.profilePicture;
          console.log("Got user profile picture:", window.currentUserProfilePicture);
        } else {
          console.log("No profile picture in user data");
        }
      } else {
        console.log("User response not OK:", userResponse.status);
      }
    } catch (userErr) {
      console.error("Error fetching user profile:", userErr);
    }
    
    // Make direct request with authorization headers
    const response = await fetch(`${_config.api.invokeUrl}/cms/posts/list?includeAuthorData=basic`, {
      method: 'GET',
      headers: {
        'Authorization': idToken,
        'Content-Type': 'application/json'
      },
      credentials: 'include'
    });
    
    console.log("Response status:", response.status);
    console.log("Response headers:", [...response.headers.entries()]);
    
    if (!response.ok) {
      const errorText = await response.text().catch(() => "No error text");
      console.error("Error response:", errorText);
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const posts = await response.json();
    console.log("Posts:", posts);

    const html = posts.map(p => {
      // Format the timestamp
      const timestamp = new Date(p.Timestamp).toLocaleString();
      
      // Use the post-author-handler utility to format the author name
      const authorName = window.postAuthorHandler.formatAuthorName(p);
      
      // Create post HTML
      return `
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <strong>${p.Title || 'Untitled Post'}</strong>
            </div>
            <small class="text-muted">${timestamp}</small>
          </div>
          <div class="card-body">
            <p class="card-text">${p.Message || ''}</p>
            ${p.AttachmentURL ? `<a href="${p.AttachmentURL}" target="_blank" class="btn btn-sm btn-outline-primary">View Attachment</a>` : ''}
          </div>
          <div class="card-footer text-muted">
            Posted by ${authorName}
          </div>
        </div>
      `;
    }).join('');
    
    document.getElementById('announcements').innerHTML = html || '<p class="text-center">No announcements found</p>';
    
  } catch (err) {
    console.error("Error loading posts:", err);
    document.getElementById('announcements').innerHTML = `
      <div class="alert alert-danger">
        Error loading announcements: ${err.message}
      </div>
    `;
  }
}

// Function to handle post submission
async function submitPost() {
  try {
    const title = document.getElementById('postTitle').value;
    const message = document.getElementById('postMessage').value;
    const group = document.getElementById('postGroup').value;
    const attachment = document.getElementById('postAttachment').files[0];
    
    if (!title || !message) {
      throw new Error('Please fill in all required fields');
    }
    
    const statusEl = document.getElementById('postStatus');
    statusEl.textContent = 'Submitting post...';
    statusEl.classList.add('alert-info');
    statusEl.classList.remove('d-none', 'alert-danger', 'alert-success');
    
    const session = await Amplify.Auth.currentSession();
    const idToken = session.getIdToken().getJwtToken();
    
    // Create post data
    const postData = {
      title: title,
      message: message,
      group: group
    };
    
    // If there's an attachment, upload it first
    if (attachment) {
      // Handle attachment upload logic here
      // This is a placeholder - actual implementation would depend on your backend
      console.log("Attachment would be uploaded here:", attachment);
    }
    
    // Submit post
    const response = await fetch(`${_config.api.invokeUrl}/cms/posts`, {
      method: 'POST',
      headers: {
        'Authorization': idToken,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(postData)
    });
    
    if (!response.ok) {
      const errorText = await response.text().catch(() => "No error text");
      throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
    }
    
    // Show success message
    statusEl.textContent = 'Post submitted successfully!';
    statusEl.classList.add('alert-success');
    statusEl.classList.remove('alert-info', 'alert-danger');
    
    // Clear form
    document.getElementById('postTitle').value = '';
    document.getElementById('postMessage').value = '';
    document.getElementById('postAttachment').value = '';
    
    // Reload posts after a delay
    setTimeout(() => {
      const modal = bootstrap.Modal.getInstance(document.getElementById('createPostModal'));
      modal.hide();
      loadPosts();
    }, 1500);
    
  } catch (err) {
    console.error("Error submitting post:", err);
    const statusEl = document.getElementById('postStatus');
    statusEl.textContent = `Error: ${err.message}`;
    statusEl.classList.add('alert-danger');
    statusEl.classList.remove('d-none', 'alert-info', 'alert-success');
  }
}

// Set up event listeners
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('submitPost').addEventListener('click', submitPost);
  document.getElementById('viewProfileBtn').addEventListener('click', function() {
    window.location.href = 'profile.html';
  });
});

// Wait for Amplify to load
window.onload = function() {
  if (typeof window.aws_amplify !== 'undefined') {
    window.Amplify = window.aws_amplify.Amplify;
  }
  
  try {
    if (typeof Amplify === 'undefined') {
      throw new Error("AWS Amplify is not loaded");
    }
    
    // Configure Amplify
    Amplify.configure(window.awsConfig);
    
    // Load posts
    setTimeout(() => {
      loadPosts();
    }, 500);
    
  } catch (error) {
    console.error("Error initializing:", error);
    document.getElementById('announcements').innerHTML = `
      <div class="alert alert-danger">
        Error initializing: ${error.message}
      </div>
    `;
  }
};
  </script>
</body>
</html>