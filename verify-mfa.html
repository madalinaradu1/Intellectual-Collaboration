<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Verify MFA - IC CMS</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light">
  <div class="container d-flex justify-content-center align-items-center vh-100">
    <div class="card shadow p-4" style="max-width: 500px; width: 100%;">
      <h3 class="text-center mb-4">Set Up MFA</h3>
      <p>Scan the QR code with Google Authenticator or Authy, then enter the 6-digit code.</p>
      <canvas id="qrcode" class="mx-auto d-block mb-3"></canvas>
      <input
        type="text"
        id="totp-code"
        class="form-control mb-3"
        placeholder="Enter 6-digit code"
      />
      <button onclick="verifyCode()" class="btn btn-primary w-100">Verify</button>
      <div id="mfa-status" class="mt-3 text-center"></div>
    </div>
  </div>

  <!-- Amplify & QR Code libraries -->
  <script src="https://cdn.jsdelivr.net/npm/aws-amplify@5.0.4/dist/aws-amplify.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <!-- Your config and auth logic -->
  <script src="config.js"></script>

  <script>
    // Configure Amplify with your Cognito settings
    Amplify.configure({
      Auth: {
        region: _config.cognito.region,
        userPoolId: _config.cognito.userPoolId,
        userPoolWebClientId: _config.cognito.userPoolClientId
      }
    });

    let currentUser;

    // Generate and display the QR code
    async function loadQRCode() {
      try {
        currentUser = await Amplify.Auth.currentAuthenticatedUser();
        const secret = await Amplify.Auth.setupTOTP(currentUser);
        const otpAuthUrl = `otpauth://totp/IC:${currentUser.username}?secret=${secret}&issuer=IC`;
        QRCode.toCanvas(document.getElementById("qrcode"), otpAuthUrl);
      } catch (err) {
        console.error(err);
        document.getElementById("mfa-status").textContent =
          "❌ Failed to generate QR code.";
      }
    }

    // Verify the 6-digit code user enters
    async function verifyCode() {
      const code = document.getElementById("totp-code").value.trim();
      try {
        await Amplify.Auth.verifyTotpToken(currentUser, code);
        await Amplify.Auth.setPreferredMFA(currentUser, "TOTP");
        document.getElementById("mfa-status").textContent =
          "✅ MFA verified! Redirecting...";
        setTimeout(() => (window.location.href = "index.html"), 1500);
      } catch (err) {
        console.error(err);
        document.getElementById("mfa-status").textContent =
          "❌ Invalid code. Try again.";
      }
    }

    // Initialize on page load
    loadQRCode();
  </script>
</body>
</html>
