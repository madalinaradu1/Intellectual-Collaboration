<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IC CMS - Dashboard</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    .banner {
      background-color: #6f42c1; /* Bootstrap purple */
      color: white;
      padding: 2rem 1rem;
      text-align: center;
      border-radius: 0 0 8px 8px;
      margin-bottom: 2rem;
    }
  </style>
  
  <!-- AWS Amplify (load in head with defer) -->
  <script defer src="https://unpkg.com/aws-amplify@4.3.43/dist/aws-amplify.min.js"></script>
</head>
<body class="bg-light">
  <!-- Purple Banner -->
  <div class="banner">
    <h1 class="mb-2">Welcome to the IC Content Management System</h1>
    <p class="lead mb-0">Connect, manage, and collaborate ‚Äî all in one place.</p>
  </div>

  <div class="container">
    <!-- Greeting -->
    <div id="user-greeting" class="alert alert-info text-center d-none"></div>

    <!-- Announcements -->
    <section class="mb-4">
      <h4 class="text-primary">üì¢ Announcements</h4>
      <div id="announcements" class="bg-white p-3 border rounded shadow-sm">
        <p>Loading announcements...</p>
      </div>
    </section>

    <!-- Quick Actions -->
    <section class="mb-4">
      <h4 class="text-success">‚ö° Quick Actions</h4>
      <div class="row g-3">
        <div class="col-md-4">
          <button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#createPostModal">Create New Post</button>
        </div>
        <div class="col-md-4">
          <button class="btn btn-outline-secondary w-100">Manage Groups</button>
        </div>
        <div class="col-md-4">
          <button class="btn btn-outline-dark w-100">View Users</button>
        </div>
      </div>
    </section>
    
    <!-- Create Post Modal -->
    <div class="modal fade" id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createPostModalLabel">Create New Post</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="createPostForm">
              <div class="mb-3">
                <label for="postTitle" class="form-label">Title</label>
                <input type="text" class="form-control" id="postTitle" required>
              </div>
              <div class="mb-3">
                <label for="postGroup" class="form-label">Group</label>
                <select class="form-control" id="postGroup">
                  <option value="general">General</option>
                  <option value="faculty">Faculty</option>
                  <option value="staff">Staff</option>
                  <option value="students">Students</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="postMessage" class="form-label">Message</label>
                <textarea class="form-control" id="postMessage" rows="4" required></textarea>
              </div>
              <div class="mb-3">
                <label for="postAttachment" class="form-label">Attachment (optional)</label>
                <input type="file" class="form-control" id="postAttachment">
                <div class="form-text">Max file size: 5MB</div>
              </div>
            </form>
            <div id="postStatus" class="alert d-none"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="submitPost">Post</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Events -->
    <section>
      <h4 class="text-warning">üìÖ Upcoming Events</h4>
      <ul class="list-group shadow-sm">
        <li class="list-group-item">üéì Faculty Training ‚Äì Sept 10</li>
        <li class="list-group-item">üõ†Ô∏è System Maintenance ‚Äì Sept 14</li>
        <li class="list-group-item">üì¢ Town Hall ‚Äì Sept 21</li>
      </ul>
    </section>
  </div>

  <!-- jQuery and Bootstrap -->
  <script src="jquery-3.1.0.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Configuration -->
  <script src="config.js"></script>
  <script src="amplify-config.js"></script>

  <script>
async function loadPosts() {
  try {
    const session = await Amplify.Auth.currentSession();
    
    // Get ID token for authorization
    const idToken = session.getIdToken().getJwtToken();
    console.log("Using ID Token for authorization");
    
    // Make direct request with authorization headers
    const response = await fetch(`${_config.api.invokeUrl}/cms/posts/list`, {
      method: 'GET',
      headers: {
        'Authorization': idToken,
        'Content-Type': 'application/json'
      },
      credentials: 'include'
    });
    
    console.log("Response status:", response.status);
    console.log("Response headers:", [...response.headers.entries()]);
    
    if (!response.ok) {
      const errorText = await response.text().catch(() => "No error text");
      console.error("Error response:", errorText);
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const posts = await response.json();
    console.log("Posts:", posts);

    const html = posts.map(p => {
      // Check if post has an attachment
      const attachmentHtml = p.Attachment ? `
        <div class="mt-2">
          <a href="${p.Attachment.FileUrl}" target="_blank" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-paperclip"></i> ${p.Attachment.FileName}
          </a>
        </div>
      ` : '';
      
      return `
      <div class="border-bottom mb-3 pb-2">
        <h5>${p.Title}</h5>
        <p class="text-muted small">By ${p.Author} ‚Ä¢ ${p.Timestamp}</p>
        <p>${p.Message}</p>
        ${attachmentHtml}
      </div>
      `;
    }).join("");

    document.getElementById("announcements").innerHTML = html || "<p>No posts found.</p>";

  } catch (err) {
    console.error("Error loading posts:", err);
    document.getElementById("announcements").textContent = "‚ùå Could not load posts.";
  }
}

    // Function to get a presigned URL for S3 upload
    async function getPresignedUrl(fileName, fileType) {
      try {
        const session = await Amplify.Auth.currentSession();
        const idToken = session.getIdToken().getJwtToken();
        
        const response = await fetch(`${_config.api.invokeUrl}/cms/posts/getUploadUrl`, {
          method: 'POST',
          headers: {
            'Authorization': idToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            fileName: fileName,
            fileType: fileType
          })
        });
        
        const data = await response.json();
        
        // Check if file exists (status code 409 Conflict)
        if (response.status === 409 && data.fileExists) {
          return {
            fileExists: true,
            fileName: data.fileName
          };
        }
        
        if (!response.ok) {
          throw new Error('Failed to get upload URL');
        }
        
        return data;
      } catch (err) {
        console.error("Error getting presigned URL:", err);
        throw err;
      }
    }
    
    // Function to upload file to S3 using presigned URL
    async function uploadFileToS3(presignedUrl, file) {
      try {
        console.log("Uploading to URL:", presignedUrl);
        
        // Don't add Content-Type header - it's already in the presigned URL
        const response = await fetch(presignedUrl, {
          method: 'PUT',
          body: file,
          // Remove Content-Type header as it can interfere with the signature
          mode: 'cors'
        });
        
        console.log("S3 upload response status:", response.status);
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => "No error details");
          console.error("S3 error response:", errorText);
          throw new Error(`Failed to upload file to S3: ${response.status} ${response.statusText}`);
        }
        
        return true;
      } catch (err) {
        console.error("Error uploading to S3:", err);
        throw err;
      }
    }
    
    // Function to handle file upload with conflict resolution
    async function handleFileUpload(file) {
      const statusEl = document.getElementById('postStatus');
      
      try {
        // First attempt to get presigned URL
        let uploadData = await getPresignedUrl(file.name, file.type);
        
        // If we get a file exists error, prompt user for a new name
        if (uploadData.fileExists) {
          statusEl.textContent = `File "${file.name}" already exists. Please rename it.`;
          statusEl.classList.add('alert-warning');
          statusEl.classList.remove('d-none', 'alert-danger', 'alert-success', 'alert-info');
          
          // Create rename form
          const renameForm = document.createElement('div');
          renameForm.className = 'mt-2';
          renameForm.innerHTML = `
            <div class="input-group">
              <input type="text" class="form-control" id="newFileName" value="${file.name}">
              <button class="btn btn-outline-secondary" type="button" id="renameFileBtn">Rename</button>
            </div>
          `;
          
          statusEl.appendChild(renameForm);
          
          // Wait for user to rename file
          return new Promise((resolve, reject) => {
            document.getElementById('renameFileBtn').addEventListener('click', async () => {
              const newFileName = document.getElementById('newFileName').value.trim();
              if (!newFileName) {
                return;
              }
              
              try {
                statusEl.textContent = `Trying with new name: ${newFileName}...`;
                statusEl.classList.add('alert-info');
                statusEl.classList.remove('alert-warning', 'alert-danger', 'alert-success');
                
                // Try upload with new name
                uploadData = await getPresignedUrl(newFileName, file.type);
                
                if (uploadData.fileExists) {
                  statusEl.textContent = `File "${newFileName}" also exists. Please try another name.`;
                  statusEl.classList.add('alert-warning');
                  statusEl.classList.remove('alert-info', 'alert-danger', 'alert-success');
                  return;
                }
                
                // Create a new file object with the new name
                const newFile = new File([file], newFileName, { type: file.type });
                
                // Upload file with new name
                await uploadFileToS3(uploadData.uploadUrl, newFile);
                resolve(uploadData);
              } catch (err) {
                reject(err);
              }
            });
          });
        }
        
        // Upload file
        await uploadFileToS3(uploadData.uploadUrl, file);
        return uploadData;
      } catch (err) {
        console.error("Error handling file upload:", err);
        throw err;
      }
    }
    
    // Function to create a new post
    async function createPost() {
      try {
        // Get form values
        const title = document.getElementById('postTitle').value.trim();
        const message = document.getElementById('postMessage').value.trim();
        const groupId = document.getElementById('postGroup').value;
        const fileInput = document.getElementById('postAttachment');
        const statusEl = document.getElementById('postStatus');
        
        // Validate
        if (!title || !message) {
          statusEl.textContent = "Please fill in all required fields";
          statusEl.classList.add('alert-danger');
          statusEl.classList.remove('d-none', 'alert-success');
          return;
        }
        
        // Get current user and token
        const session = await Amplify.Auth.currentSession();
        const idToken = session.getIdToken().getJwtToken();
        const user = await Amplify.Auth.currentAuthenticatedUser();
        const username = user.getUsername();
        
        // Create post object
        const postData = {
          Title: title,
          Message: message,
          Author: username,
          groupId: groupId,
          Timestamp: new Date().toISOString()
        };
        
        // Handle file attachment if present
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          
          // Check file size (5MB limit)
          if (file.size > 5 * 1024 * 1024) {
            statusEl.textContent = "File size exceeds 5MB limit";
            statusEl.classList.add('alert-danger');
            statusEl.classList.remove('d-none', 'alert-success');
            return;
          }
          
          statusEl.textContent = "Uploading attachment...";
          statusEl.classList.add('alert-info');
          statusEl.classList.remove('d-none', 'alert-danger', 'alert-success');
          
          try {
            // Use the new handler function that checks for file existence
            const uploadData = await handleFileUpload(file);
            
            // Add attachment info to post data
            postData.Attachment = {
              FileName: uploadData.fileKey.split('/').pop(), // Get just the filename part
              FileType: file.type,
              FileKey: uploadData.fileKey,
              FileUrl: uploadData.fileUrl
            };
          } catch (err) {
            console.error("Error handling attachment:", err);
            statusEl.textContent = "Failed to upload attachment: " + err.message;
            statusEl.classList.add('alert-danger');
            statusEl.classList.remove('d-none', 'alert-info', 'alert-success');
            return;
          }
        }
        
        // Log what we're sending
        console.log("Sending post data:", JSON.stringify(postData));
        
        // Send to API
        const response = await fetch(`${_config.api.invokeUrl}/cms/posts/create`, {
          method: 'POST',
          headers: {
            'Authorization': idToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(postData),
          credentials: 'include'
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Failed to create post: ${errorText}`);
        }
        
        // Show success message
        statusEl.textContent = "Post created successfully!";
        statusEl.classList.add('alert-success');
        statusEl.classList.remove('d-none', 'alert-danger');
        
        // Clear form
        document.getElementById('postTitle').value = '';
        document.getElementById('postMessage').value = '';
        document.getElementById('postAttachment').value = '';
        
        // Reload posts after a short delay
        setTimeout(() => {
          loadPosts();
          // Close modal after success
          const modal = bootstrap.Modal.getInstance(document.getElementById('createPostModal'));
          modal.hide();
          
          // Remove modal backdrop and restore body scrolling
          document.querySelector('.modal-backdrop')?.remove();
          document.body.classList.remove('modal-open');
          document.body.style.overflow = '';
          document.body.style.paddingRight = '';
        }, 1500);
        
      } catch (err) {
        console.error("Error creating post:", err);
        const statusEl = document.getElementById('postStatus');
        statusEl.textContent = `Error: ${err.message}`;
        statusEl.classList.add('alert-danger');
        statusEl.classList.remove('d-none', 'alert-success');
      }
    }

    // Wait for Amplify to load
    window.onload = function() {
      console.log("Window loaded");
      
      // Test if Bootstrap modal is working
      const createButton = document.querySelector('button[data-bs-toggle="modal"]');
      console.log("Create button found:", createButton);
      createButton.addEventListener('click', function() {
        console.log("Create button clicked");
        const modal = new bootstrap.Modal(document.getElementById('createPostModal'));
        modal.show();
      });
      
      if (typeof window.aws_amplify !== 'undefined') {
        // Use aws_amplify namespace
        window.Amplify = window.aws_amplify.Amplify;
        console.log("Amplify loaded via aws_amplify namespace");
      }
      
      try {
        if (typeof Amplify === 'undefined') {
          throw new Error("AWS Amplify is not loaded");
        }
        
        // Configure Amplify
        Amplify.configure(window.awsConfig);
        
        // Check authentication and load user info
        Amplify.Auth.currentAuthenticatedUser()
          .then(user => {
            const username = user.getUsername();
            document.getElementById("user-greeting").classList.remove("d-none");
            document.getElementById("user-greeting").textContent = `Welcome, ${username}! You are now logged in.`;

            // Don't show temporary announcements, just load posts
            setTimeout(() => {
              loadPosts();
            }, 500);
            
            // Set up event listener for post submission
            document.getElementById('submitPost').addEventListener('click', function() {
              console.log("Submit post button clicked");
              createPost();
              // Move focus to a visible element after submission
              document.querySelector('.banner h1').focus();
            });
          })
          .catch(err => {
            console.warn("Not logged in:", err);
            window.location.href = "signin.html";
          });
      } catch (error) {
        console.error("Error initializing Amplify:", error);
        document.getElementById("announcements").textContent = "‚ùå Authentication system error. Please try again later.";
      }
    };
  </script>
</body>
</html>